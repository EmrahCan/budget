# Azure DevOps Pipeline for Budget App
# Deploys to Azure Web App with PostgreSQL Database

trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Build Configuration
  buildConfiguration: 'production'
  nodeVersion: '18.x'
  
  # Azure Resources
  azureSubscription: 'Visual Studio Enterprise Aboneliƒüi'
  webAppName: 'budgetapp'
  resourceGroupName: 'DarkSide-RG-WebApp'
  
  # Database Configuration
  dbHost: 'budgetapp-server.postgres.database.azure.com'
  dbName: 'budgetapp-database'
  dbUser: 'bzexmlrqxt'

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Build Frontend and Backend'
        steps:
          # Checkout code
          - checkout: self
            displayName: 'Checkout Repository'

          # Setup Node.js
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'Install Node.js $(nodeVersion)'

          # Install Backend Dependencies
          - script: |
              cd backend
              npm ci --production
            displayName: 'Install Backend Dependencies'

          # Install Frontend Dependencies
          - script: |
              cd frontend
              npm ci
            displayName: 'Install Frontend Dependencies'

          # Build Frontend
          - script: |
              cd frontend
              npm run build
            displayName: 'Build Frontend (React)'
            env:
              REACT_APP_API_URL: '/api'
              REACT_APP_ENVIRONMENT: 'production'
              REACT_APP_DEBUG: 'false'
              REACT_APP_ENABLE_DEVTOOLS: 'false'
              REACT_APP_LOG_LEVEL: 'error'
              REACT_APP_NAME: 'Budget App'
              REACT_APP_VERSION: '2.0.0'

          # Create deployment package
          - script: |
              mkdir -p $(Build.ArtifactStagingDirectory)/app
              
              # Copy backend
              cp -r backend $(Build.ArtifactStagingDirectory)/app/
              
              # Copy frontend build
              cp -r frontend/build $(Build.ArtifactStagingDirectory)/app/frontend-build
              
              # Copy package files
              cp backend/package.json $(Build.ArtifactStagingDirectory)/app/
              cp backend/package-lock.json $(Build.ArtifactStagingDirectory)/app/
              
              # Create web.config for Azure
              cat > $(Build.ArtifactStagingDirectory)/app/web.config << 'EOF'
              <?xml version="1.0" encoding="utf-8"?>
              <configuration>
                <system.webServer>
                  <handlers>
                    <add name="iisnode" path="backend/server.js" verb="*" modules="iisnode"/>
                  </handlers>
                  <rewrite>
                    <rules>
                      <!-- API routes -->
                      <rule name="API">
                        <match url="^api/(.*)"/>
                        <action type="Rewrite" url="backend/server.js"/>
                      </rule>
                      <!-- Static files -->
                      <rule name="StaticContent">
                        <action type="Rewrite" url="frontend-build{REQUEST_URI}"/>
                      </rule>
                      <!-- SPA fallback -->
                      <rule name="SPA">
                        <match url=".*"/>
                        <conditions logicalGrouping="MatchAll">
                          <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true"/>
                          <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true"/>
                          <add input="{REQUEST_URI}" pattern="^/api" negate="true"/>
                        </conditions>
                        <action type="Rewrite" url="frontend-build/index.html"/>
                      </rule>
                    </rules>
                  </rewrite>
                  <iisnode nodeProcessCommandLine="node" />
                </system.webServer>
              </configuration>
              EOF
            displayName: 'Create Deployment Package'

          # Publish artifact
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/app'
              ArtifactName: 'drop'
              publishLocation: 'Container'
            displayName: 'Publish Build Artifacts'

  - stage: DatabaseMigration
    displayName: 'Database Migration'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: MigrateDatabase
        displayName: 'Run Database Migrations'
        steps:
          # Checkout for migration scripts
          - checkout: self
            displayName: 'Checkout Repository'

          # Install PostgreSQL client
          - script: |
              sudo apt-get update
              sudo apt-get install -y postgresql-client
            displayName: 'Install PostgreSQL Client'

          # Run migrations
          - task: AzureCLI@2
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get database password from Key Vault or use secure variable
                DB_PASSWORD="$(DB_PASSWORD)"
                
                export PGPASSWORD="$DB_PASSWORD"
                
                echo "üîÑ Running database migrations..."
                
                # Main schema
                echo "üìä Main schema..."
                psql -h $(dbHost) -p 5432 -U $(dbUser) -d $(dbName) -f backend/database/schema.sql || echo "Schema already exists"
                
                # AI tables
                echo "ü§ñ AI tables..."
                psql -h $(dbHost) -p 5432 -U $(dbUser) -d $(dbName) -f backend/database/migrations/add_ai_tables.sql || echo "AI tables already exist"
                
                # Notification columns
                echo "üîî Notification columns..."
                psql -h $(dbHost) -p 5432 -U $(dbUser) -d $(dbName) -f backend/database/migrations/add_notification_columns.sql || echo "Notification columns already exist"
                
                # User language preference
                echo "üåç User language preference..."
                psql -h $(dbHost) -p 5432 -U $(dbUser) -d $(dbName) -f backend/database/migrations/add_user_language_preference.sql || echo "Language preference already exists"
                
                echo "‚úÖ Migrations completed!"
                
                unset PGPASSWORD
            displayName: 'Run Database Migrations'
            env:
              DB_PASSWORD: $(DB_PASSWORD)

  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: DatabaseMigration
    condition: succeeded()
    jobs:
      - deployment: DeployWeb
        displayName: 'Deploy to Azure Web App'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                # Download artifact
                - download: current
                  artifact: drop
                  displayName: 'Download Build Artifacts'

                # Deploy to Azure Web App
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: 'webAppLinux'
                    appName: $(webAppName)
                    package: '$(Pipeline.Workspace)/drop'
                    runtimeStack: 'NODE|18-lts'
                    startUpCommand: 'node backend/server.js'
                  displayName: 'Deploy to Azure Web App'

                # Restart Web App
                - task: AzureAppServiceManage@0
                  inputs:
                    azureSubscription: $(azureSubscription)
                    Action: 'Restart Azure App Service'
                    WebAppName: $(webAppName)
                  displayName: 'Restart Web App'

  - stage: Verify
    displayName: 'Verify Deployment'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: VerifyDeployment
        displayName: 'Health Check'
        steps:
          # Wait for app to start
          - script: |
              echo "‚è≥ Waiting for app to start..."
              sleep 30
            displayName: 'Wait for App Startup'

          # Health check
          - script: |
              echo "üîç Running health check..."
              
              APP_URL="https://budgetapp-bkabcabubzhmazbk.centralus-01.azurewebsites.net"
              
              # Check frontend
              echo "üì± Checking frontend..."
              FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL)
              echo "Frontend status: $FRONTEND_STATUS"
              
              # Check API health
              echo "üîß Checking API..."
              API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL/api/health)
              echo "API status: $API_STATUS"
              
              if [ "$FRONTEND_STATUS" = "200" ] && [ "$API_STATUS" = "200" ]; then
                echo "‚úÖ Deployment verified successfully!"
                exit 0
              else
                echo "‚ùå Deployment verification failed!"
                exit 1
              fi
            displayName: 'Verify Deployment'
